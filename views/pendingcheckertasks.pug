extends layouts/_layout.pug

block variables
	- var activePage = 'pendingcheckertasks'
	- var activeGroup = 'checker'
	- var allowed_to_approve_decline = sails.config.custom.allowed_to_approve_decline_uploaded_files[role]

block title
	title Pending Checker's Task

block content
	
	.row
		.col-md-12
			.tile
				.tile-body
					table.table.table-hover.table-bordered#checkertasks_list_table
						thead
							tr
								th Created On
								th Created By
								th Maker Data
								th Status
								if allowed_to_approve_decline
									th Approve
									th Decline
								th Reason
						tbody
							each checkertask in checkertasks
								tr(id=checkertask.id)
									td #{sails.config.custom.getReadableDate(checkertask.createdAt, true)}
									td=checkertask.created_by
									td
										button.btn.btn-sm.btn-outline-primary 
											a(href=sails.config.custom.base_url + checkertask.job_inputs.slice(sails.config.appPath.length)) Download
									td
										if checkertask.job_status === 'working'
											div.progress
												div.progress-bar.progress-bar-striped.progress-bar-animated(role="progressbar" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100" style="width: 100%")
										else
											=checkertask.job_status
											
									if allowed_to_approve_decline
										td
											if checkertask.job_status === 'pending'
												button.btn.btn-sm.btn-outline-success(onclick='approvecheckertask("' + checkertask.id + '", true)') APPROVE
												
									if allowed_to_approve_decline
										td
											if checkertask.job_status === 'pending'
												button.btn.btn-sm.btn-outline-danger(onclick='approvecheckertask("' + checkertask.id + '", false)') DECLINE
												
									td=checkertask.reason
						
block specific-js
	// Data table plugin
	include includes/datatable_js.pug
	
	script.
		let checkertasks_list_table = $('#checkertasks_list_table').DataTable({
			dom: 'lfrtBip',
			buttons: [
				'copy', 'csv', 'excel', 'pdf', 'print'
			]
		});
	
	if allowed_to_approve_decline
		script.
			function approvecheckertask(checkertaskid, approve) {
				swal({
					title: (approve ? "Approval" : "Decline") + " Message", 
					text: "",
					content: {
						element: "input",
						attributes: {
							placeholder: "(Required)",
						}
					},
				}).then((message) => {
					if(message || message == null) {	//	we get value as null when the swal is closed by escape key
						if(message != null) {
							$.post('/approvecheckertask', {checkertaskid: checkertaskid, approve: approve, reason: message}, function(data) {
								if(data.errormsg) {
									swal(data.errormsg, "", "error");
								} else {
									if(approve) {
										let d = checkertasks_list_table.row($('#'+checkertaskid)).data();
										d[3] = '<div class= "progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div></div>';
										d[4] = "";
										d[5] = "";
										d[6] = message;
										checkertasks_list_table.row($('#'+checkertaskid)).data(d);
									} else {
										checkertasks_list_table.row($('#'+checkertaskid)).remove().draw();
									}
								}
							});
						}
					} else {
						//	Ask the user to fill the message
						approvecheckertask(checkertaskid, approve);
					}
				});
			}